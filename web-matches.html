<!DOCTYPE html>
<html lang="en">
<head>
  <script src="./auth-check.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Matches - VeriSource™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  
  <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center text-slate-950 font-bold text-xl">
            V
          </div>
          <div>
            <div class="text-lg font-semibold tracking-tight">
              VeriSource<span class="align-top text-xs ml-0.5">™</span>
            </div>
            <p class="text-xs text-slate-400">Web Matches</p>
          </div>
        </div>
        <button onclick="window.close()" class="text-sm px-4 py-2 rounded-lg border border-slate-700 hover:border-blue-500 hover:bg-slate-900 transition">
          ← Close
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    
    <div id="content" class="space-y-8">
      <div class="text-center py-20">
        <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-blue-500 border-r-transparent"></div>
        <p class="text-sm text-slate-400 mt-4">Loading search results...</p>
      </div>
    </div>

  </main>

  <script>
    // Read data from sessionStorage
    const dataStr = sessionStorage.getItem('verificationData');
    
    if (!dataStr) {
      document.getElementById('content').innerHTML = `
        <div class="text-center py-20">
          <p class="text-red-400">No verification data found</p>
          <button onclick="window.close()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-400">
            Close Window
          </button>
        </div>
      `;
    } else {
      try {
        const data = JSON.parse(dataStr);
        displayResults(data);
      } catch (e) {
        document.getElementById('content').innerHTML = `
          <div class="text-center py-20">
            <p class="text-red-400">Error loading data: ${e.message}</p>
          </div>
        `;
      }
    }

    function displayResults(data) {
      const googleVision = data.google_vision || data.external_checks?.google_vision || {};
      const virusTotal = data.virustotal || data.external_checks?.virustotal || {};
      const webDetection = googleVision.web_detection || {};
      
      const matchingPages = webDetection.pages_with_matching_images || [];
      const fullMatches = webDetection.full_matching_images || [];
      const partialMatches = webDetection.partial_matching_images || [];
      const visuallySimilar = webDetection.visually_similar_images || [];
      
      const totalResults = matchingPages.length + fullMatches.length + partialMatches.length + visuallySimilar.length;
      
      const html = `
        <!-- Header Section -->
        <div class="bg-gradient-to-br from-slate-900/80 to-slate-800/60 border-2 border-blue-500/30 rounded-xl p-8 fade-in">
          <div class="flex items-center gap-4 mb-4">
            <div class="h-16 w-16 rounded-full bg-blue-500/10 flex items-center justify-center">
              <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-3xl font-bold text-blue-400">Web Matches Found</h1>
              <p class="text-slate-400 mt-1">Content found across ${totalResults} location(s) online</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-slate-950/50 rounded-lg p-4 text-center">
              <p class="text-2xl font-bold text-blue-400">${matchingPages.length}</p>
              <p class="text-xs text-slate-500 mt-1">Pages with Image</p>
            </div>
            <div class="bg-slate-950/50 rounded-lg p-4 text-center">
              <p class="text-2xl font-bold text-green-400">${fullMatches.length}</p>
              <p class="text-xs text-slate-500 mt-1">Full Matches</p>
            </div>
            <div class="bg-slate-950/50 rounded-lg p-4 text-center">
              <p class="text-2xl font-bold text-yellow-400">${partialMatches.length}</p>
              <p class="text-xs text-slate-500 mt-1">Partial Matches</p>
            </div>
            <div class="bg-slate-950/50 rounded-lg p-4 text-center">
              <p class="text-2xl font-bold text-purple-400">${visuallySimilar.length}</p>
              <p class="text-xs text-slate-500 mt-1">Similar Images</p>
            </div>
          </div>

          ${data.filename ? `
          <div class="mt-4 pt-4 border-t border-slate-700">
            <p class="text-sm text-slate-400">
              <span class="text-slate-500">File:</span> 
              <span class="text-slate-300 font-medium">${data.filename}</span>
            </p>
          </div>
          ` : ''}
        </div>

        ${virusTotal.found ? `
        <!-- VirusTotal Section -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            VirusTotal Results
          </h2>
          <div class="bg-slate-800/30 rounded-lg p-4 space-y-2">
            <div class="flex justify-between">
              <span class="text-slate-500">Status:</span>
              <span class="text-green-400 font-semibold">Found in Database</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-500">Upload Count:</span>
              <span class="text-slate-300">${virusTotal.upload_count || 'Multiple'} times</span>
            </div>
            ${virusTotal.first_seen ? `
            <div class="flex justify-between">
              <span class="text-slate-500">First Seen:</span>
              <span class="text-slate-300">${new Date(virusTotal.first_seen).toLocaleString()}</span>
            </div>
            ` : ''}
            ${virusTotal.last_seen ? `
            <div class="flex justify-between">
              <span class="text-slate-500">Last Seen:</span>
              <span class="text-slate-300">${new Date(virusTotal.last_seen).toLocaleString()}</span>
            </div>
            ` : ''}
          </div>
        </div>
        ` : ''}

        ${matchingPages.length > 0 ? `
        <!-- Pages with Matching Images -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
            </svg>
            Pages with Matching Images (${matchingPages.length})
          </h2>
          <div class="space-y-3">
            ${matchingPages.map((page, idx) => `
              <div class="bg-slate-800/30 hover:bg-slate-800/50 rounded-lg p-4 transition">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 font-semibold text-sm">
                    ${idx + 1}
                  </div>
                  <div class="flex-1 min-w-0">
                    <a href="${page.url}" target="_blank" class="text-blue-400 hover:text-blue-300 font-medium hover:underline block mb-1">
                      ${page.page_title || 'Untitled Page'}
                    </a>
                    <p class="text-xs text-slate-500 break-all">${page.url}</p>
                  </div>
                  <a href="${page.url}" target="_blank" class="flex-shrink-0 text-xs px-3 py-1 rounded bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 transition">
                    Visit →
                  </a>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}

        ${fullMatches.length > 0 ? `
        <!-- Full Matching Images -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Full Matching Images (${fullMatches.length})
          </h2>
          <div class="grid md:grid-cols-2 gap-3">
            ${fullMatches.map((img, idx) => `
              <div class="bg-slate-800/30 hover:bg-slate-800/50 rounded-lg p-3 transition">
                <div class="flex items-center gap-2 mb-2">
                  <div class="flex-shrink-0 w-6 h-6 rounded bg-green-500/10 flex items-center justify-center text-green-400 font-semibold text-xs">
                    ${idx + 1}
                  </div>
                  <span class="text-xs text-slate-500 font-mono truncate flex-1">${img.url.substring(0, 50)}...</span>
                </div>
                <a href="${img.url}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 hover:underline break-all">
                  ${img.url}
                </a>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}

        ${partialMatches.length > 0 ? `
        <!-- Partial Matching Images -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Partial Matching Images (${partialMatches.length})
          </h2>
          <div class="grid md:grid-cols-2 gap-3">
            ${partialMatches.map((img, idx) => `
              <div class="bg-slate-800/30 hover:bg-slate-800/50 rounded-lg p-3 transition">
                <div class="flex items-center gap-2 mb-2">
                  <div class="flex-shrink-0 w-6 h-6 rounded bg-yellow-500/10 flex items-center justify-center text-yellow-400 font-semibold text-xs">
                    ${idx + 1}
                  </div>
                  <span class="text-xs text-slate-500 font-mono truncate flex-1">${img.url.substring(0, 50)}...</span>
                </div>
                <a href="${img.url}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 hover:underline break-all">
                  ${img.url}
                </a>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}

        ${visuallySimilar.length > 0 ? `
        <!-- Visually Similar Images -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Visually Similar Images (${visuallySimilar.length})
          </h2>
          <div class="grid md:grid-cols-2 gap-3">
            ${visuallySimilar.map((img, idx) => `
              <div class="bg-slate-800/30 hover:bg-slate-800/50 rounded-lg p-3 transition">
                <div class="flex items-center gap-2 mb-2">
                  <div class="flex-shrink-0 w-6 h-6 rounded bg-purple-500/10 flex items-center justify-center text-purple-400 font-semibold text-xs">
                    ${idx + 1}
                  </div>
                  <span class="text-xs text-slate-500 font-mono truncate flex-1">${img.url.substring(0, 50)}...</span>
                </div>
                <a href="${img.url}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 hover:underline break-all">
                  ${img.url}
                </a>
              </div>
            `).join('')}
          </div>
        </div>
        ` : ''}

        ${totalResults === 0 ? `
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-12 text-center fade-in">
          <div class="mx-auto h-16 w-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-slate-400 mb-2">No Web Matches Found</h3>
          <p class="text-sm text-slate-500">This content was not found elsewhere on the web.</p>
        </div>
        ` : ''}
      `;

      document.getElementById('content').innerHTML = html;
    }
  </script>
</body>
</html>
