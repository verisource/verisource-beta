<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verification Report - VeriSource‚Ñ¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    
    /* Status badge styles matching bulk upload */
    .status-verified-photo { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .status-likely-camera { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .status-modified { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    .status-manipulation { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .status-heavily-manipulated { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .status-ai-image { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .status-verified-video { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .status-ai-content { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .status-mixed-content { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .status-ai-video { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
    .status-deepfake { background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); }
    .status-verified-audio { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .status-natural-voice { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .status-synthetic-voice { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .status-fully-ai-audio { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    
    .duplicate-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      border-left: 4px solid #b45309;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  
  <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center text-slate-950 font-bold text-xl">
            V
          </div>
          <div>
            <div class="text-lg font-semibold tracking-tight">
              VeriSource<span class="align-top text-xs ml-0.5">‚Ñ¢</span>
            </div>
            <p class="text-xs text-slate-400">Verification Report</p>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button onclick="window.close()" class="text-sm text-slate-400 hover:text-blue-400 transition">‚Üê Close</button>
          <button onclick="window.print()" class="text-sm px-4 py-2 rounded-lg border border-slate-700 hover:border-blue-500 hover:bg-slate-900 transition">
            üñ®Ô∏è Print Report
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    
    <div id="noDataMessage" class="hidden text-center py-20">
      <div class="text-6xl mb-4">‚ö†Ô∏è</div>
      <h2 class="text-2xl font-bold mb-2">No Verification Data Found</h2>
      <p class="text-slate-400 mb-6">This report requires verification data from a bulk or single upload.</p>
      <a href="index.html" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg inline-block transition">
        Return to Home
      </a>
    </div>

    <div id="reportContent" class="space-y-6">
      
      <!-- Header Section -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <div class="flex items-start justify-between mb-6">
          <div class="flex-1">
            <h1 class="text-3xl font-bold mb-2" id="fileName">Loading...</h1>
            <div class="flex items-center gap-3 flex-wrap">
              <span id="statusBadge" class="px-4 py-2 rounded-lg text-white font-medium text-sm">
                Loading...
              </span>
              <div class="text-sm">
                <span class="text-slate-400">Overall Confidence:</span>
                <span class="font-semibold ml-1 text-2xl" id="overallConfidence">0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Duplicate Warning -->
        <div id="duplicateWarning" class="hidden duplicate-banner rounded-lg p-4 text-white mb-6">
          <div class="flex items-start gap-3">
            <div class="text-2xl">‚ö†Ô∏è</div>
            <div>
              <div class="font-semibold mb-1">Duplicate Detected</div>
              <div class="text-sm opacity-90" id="duplicateMessage"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Confidence Score Breakdown -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Confidence Score Breakdown</h2>
        <div id="confidenceBreakdown" class="space-y-3">
          <p class="text-sm text-slate-400">Loading confidence data...</p>
        </div>
      </div>

      <!-- AI Detection Results -->
      <div id="aiDetectionSection" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">AI Content Analysis</h2>
        <div id="aiDetectionContent"></div>
      </div>

      <!-- Fingerprint Details -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Fingerprint Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">File ID</div>
            <div class="font-mono text-sm" id="fileId">N/A</div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">SHA-256 Hash</div>
            <div class="font-mono text-xs break-all" id="sha256">N/A</div>
          </div>
          <div id="phashSection" class="hidden bg-slate-800/50 rounded-lg p-4 md:col-span-2">
            <div class="text-sm text-slate-400 mb-1">Perceptual Hash (pHash)</div>
            <div class="font-mono text-xs" id="phash">N/A</div>
          </div>
        </div>
      </div>

      <!-- Metadata -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Metadata</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="metadataGrid">
          <p class="text-sm text-slate-400">Loading metadata...</p>
        </div>
      </div>

      <!-- External Verification -->
      <div id="externalVerificationSection" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">External Verification</h2>
        <div id="externalVerificationContent"></div>
      </div>

      <!-- Video Frame Analysis -->
      <div id="videoAnalysisSection" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Video Frame Analysis</h2>
        <div id="videoAnalysisContent"></div>
      </div>

      <!-- Audio Analysis -->
      <div id="audioAnalysisSection" class="hidden bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Audio Analysis</h2>
        <div id="audioAnalysisContent"></div>
      </div>

      <!-- Verification History -->
      <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
        <h2 class="text-xl font-bold mb-4">Verification History</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">First Verified</div>
            <div class="text-sm" id="firstVerified">N/A</div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">Last Updated</div>
            <div class="text-sm" id="lastUpdated">N/A</div>
          </div>
          <div id="verificationCountSection" class="hidden bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">Times Verified</div>
            <div class="text-xl font-semibold" id="verificationCount">0</div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // Load verification data from sessionStorage
    function loadReport() {
      const data = sessionStorage.getItem('verificationData');
      
      if (!data) {
        document.getElementById('reportContent').classList.add('hidden');
        document.getElementById('noDataMessage').classList.remove('hidden');
        return;
      }

      const result = JSON.parse(data);
      console.log('Report data:', result);

      // Display file name
      document.getElementById('fileName').textContent = result.filename || 'Verification Report';

      // Display status badge
      const statusBadge = document.getElementById('statusBadge');
      const statusClass = getStatusClass(result);
      const statusText = getStatusText(result);
      statusBadge.className = `${statusClass} px-4 py-2 rounded-lg text-white font-medium text-sm`;
      statusBadge.textContent = statusText;

      // Display overall confidence
      const confidence = Math.round(result.overallConfidence || 0);
      document.getElementById('overallConfidence').textContent = confidence + '%';

      // Display duplicate warning
      if (result.duplicateDetection?.isDuplicate) {
        const duplicateWarning = document.getElementById('duplicateWarning');
        duplicateWarning.classList.remove('hidden');
        const firstSeen = result.duplicateDetection.firstSeen ? new Date(result.duplicateDetection.firstSeen).toLocaleDateString() : 'Unknown';
        const fileId = result.duplicateDetection.originalFileId || 'N/A';
        document.getElementById('duplicateMessage').innerHTML = `
          This file was previously verified on ${firstSeen}<br>
          Original File ID: ${fileId}
        `;
      }

      // Display confidence breakdown
      displayConfidenceBreakdown(result);

      // Display AI detection
      if (result.aiDetection) {
        displayAiDetection(result);
      }

      // Display fingerprint details
      document.getElementById('fileId').textContent = result.fileId || result.verification_id || 'N/A';
      document.getElementById('sha256').textContent = result.fingerprint?.sha256 || result.sha256 || 'N/A';
      
      if (result.fingerprint?.pHash || result.phash) {
        document.getElementById('phashSection').classList.remove('hidden');
        document.getElementById('phash').textContent = result.fingerprint?.pHash || result.phash;
      }

      // Display metadata
      displayMetadata(result);

      // Display external verification
      if (result.externalVerification) {
        displayExternalVerification(result);
      }

      // Display video analysis
      if (result.videoAnalysis) {
        displayVideoAnalysis(result);
      }

      // Display audio analysis
      if (result.audioAnalysis) {
        displayAudioAnalysis(result);
      }

      // Display verification history
      displayVerificationHistory(result);
    }

    function getStatusClass(result) {
      const mediaType = result.metadata?.format?.toLowerCase() || '';
      const isVideo = mediaType.includes('video') || mediaType.includes('mp4') || mediaType.includes('mov') || mediaType.includes('avi');
      const isAudio = mediaType.includes('audio') || mediaType.includes('mp3') || mediaType.includes('wav') || mediaType.includes('ogg');
      
      if (isVideo) {
        const aiPercent = result.videoAnalysis?.aiPercentage || 0;
        const hasDeepfake = result.videoAnalysis?.deepfakeDetected || false;
        if (hasDeepfake && aiPercent > 30) return 'status-deepfake';
        if (aiPercent >= 70) return 'status-ai-video';
        if (aiPercent >= 30) return 'status-mixed-content';
        if (aiPercent >= 5) return 'status-ai-content';
        return 'status-verified-video';
      }
      
      if (isAudio) {
        const hasAiVoice = result.audioAnalysis?.syntheticVoice || false;
        const aiConfidence = result.audioAnalysis?.aiConfidence || 0;
        if (aiConfidence >= 90) return 'status-fully-ai-audio';
        if (hasAiVoice) return 'status-synthetic-voice';
        if (aiConfidence >= 30) return 'status-natural-voice';
        return 'status-verified-audio';
      }
      
      const confidence = result.overallConfidence || 0;
      const hasAi = result.aiDetection?.isAiGenerated || false;
      const isModified = result.duplicateDetection?.isDuplicate || false;
      
      if (hasAi) return 'status-ai-image';
      if (confidence >= 75) return 'status-verified-photo';
      if (confidence >= 50 && isModified) return 'status-modified';
      if (confidence >= 50) return 'status-likely-camera';
      if (confidence >= 25) return 'status-manipulation';
      return 'status-heavily-manipulated';
    }

    function getStatusText(result) {
      const mediaType = result.metadata?.format?.toLowerCase() || '';
      const isVideo = mediaType.includes('video') || mediaType.includes('mp4') || mediaType.includes('mov') || mediaType.includes('avi');
      const isAudio = mediaType.includes('audio') || mediaType.includes('mp3') || mediaType.includes('wav') || mediaType.includes('ogg');
      
      if (isVideo) {
        const aiPercent = result.videoAnalysis?.aiPercentage || 0;
        const hasDeepfake = result.videoAnalysis?.deepfakeDetected || false;
        if (hasDeepfake && aiPercent > 30) return 'üö® DEEPFAKE INDICATORS DETECTED';
        if (aiPercent >= 70) return 'ü§ñ PRIMARILY AI-GENERATED VIDEO';
        if (aiPercent >= 30) return '‚ö†Ô∏è SIGNIFICANT MIX OF VIDEO AND AI CONTENT';
        if (aiPercent >= 5) return '‚ö° AI-GENERATED CONTENT DETECTED';
        return '‚úÖ VERIFIED VIDEO';
      }
      
      if (isAudio) {
        const hasAiVoice = result.audioAnalysis?.syntheticVoice || false;
        const aiConfidence = result.audioAnalysis?.aiConfidence || 0;
        if (aiConfidence >= 90) return 'ü§ñ FULLY AI-GENERATED AUDIO';
        if (hasAiVoice) return 'üéôÔ∏è SYNTHETIC VOICE DETECTED';
        if (aiConfidence >= 30) return 'üéµ NATURAL VOICE WITH AI AUDIO';
        return '‚úÖ VERIFIED AUDIO RECORDING';
      }
      
      const confidence = result.overallConfidence || 0;
      const hasAi = result.aiDetection?.isAiGenerated || false;
      const isModified = result.duplicateDetection?.isDuplicate || false;
      
      if (hasAi) return 'ü§ñ AI-GENERATED IMAGE';
      if (confidence >= 75) return '‚úÖ VERIFIED PHOTOGRAPH';
      if (confidence >= 50 && isModified) return 'üìù MODIFIED VERSION DETECTED';
      if (confidence >= 50) return 'üì∑ LIKELY CAMERA-CAPTURED';
      if (confidence >= 25) return '‚ö†Ô∏è MANIPULATION DETECTED';
      return 'üö´ HEAVILY MANIPULATED';
    }

    function displayConfidenceBreakdown(result) {
      const container = document.getElementById('confidenceBreakdown');
      
      if (!result.confidenceBreakdown || Object.keys(result.confidenceBreakdown).length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-400">Confidence breakdown not available</p>';
        return;
      }

      const breakdown = Object.entries(result.confidenceBreakdown)
        .filter(([key, value]) => value > 0)
        .map(([key, value]) => `
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-slate-400">${key}</span>
              <span class="font-semibold">${Math.round(value)}%</span>
            </div>
            <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 transition-all" style="width: ${value}%"></div>
            </div>
          </div>
        `).join('');

      container.innerHTML = breakdown || '<p class="text-sm text-slate-400">No confidence data available</p>';
    }

    function displayAiDetection(result) {
      const section = document.getElementById('aiDetectionSection');
      const content = document.getElementById('aiDetectionContent');
      
      section.classList.remove('hidden');
      
      const isAi = result.aiDetection.isAiGenerated || false;
      const confidence = Math.round(result.aiDetection.confidence || 0);
      const label = result.aiDetection.label || 'Unknown';

      content.innerHTML = `
        <div class="bg-slate-800/50 rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium">Detection Result</h4>
            <span class="text-sm ${isAi ? 'text-red-400' : 'text-green-400'}">
              ${isAi ? 'AI-Generated' : 'Likely Authentic'}
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-slate-400">AI Confidence:</span>
              <span class="font-semibold">${confidence}%</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Classification:</span>
              <span class="font-semibold">${label}</span>
            </div>
          </div>
        </div>
      `;
    }

    function displayMetadata(result) {
      const container = document.getElementById('metadataGrid');
      const metadata = result.metadata || {};
      
      const fields = [];
      
      if (metadata.format) {
        fields.push({ label: 'Format', value: metadata.format.toUpperCase() });
      }
      
      if (metadata.size) {
        fields.push({ label: 'File Size', value: metadata.size });
      }
      
      if (metadata.dimensions) {
        fields.push({ label: 'Dimensions', value: metadata.dimensions });
      }
      
      if (metadata.duration) {
        fields.push({ label: 'Duration', value: metadata.duration });
      }
      
      if (metadata.uploadDate) {
        fields.push({ label: 'Upload Date', value: new Date(metadata.uploadDate).toLocaleDateString() });
      }

      if (fields.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-400">No metadata available</p>';
        return;
      }

      container.innerHTML = fields.map(field => `
        <div class="bg-slate-800/50 rounded-lg p-4">
          <div class="text-sm text-slate-400 mb-1">${field.label}</div>
          <div class="text-sm font-medium">${field.value}</div>
        </div>
      `).join('');
    }

    function displayExternalVerification(result) {
      const section = document.getElementById('externalVerificationSection');
      const content = document.getElementById('externalVerificationContent');
      
      const hasVirusTotal = result.externalVerification?.virusTotal;
      const hasGoogleVision = result.externalVerification?.googleVision?.labels?.length > 0;
      
      if (!hasVirusTotal && !hasGoogleVision) return;
      
      section.classList.remove('hidden');
      
      let html = '<div class="space-y-4">';
      
      if (hasVirusTotal) {
        const vt = result.externalVerification.virusTotal;
        html += `
          <div class="bg-slate-800/50 rounded-lg p-4">
            <h4 class="font-medium mb-2">VirusTotal Scan</h4>
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-400">Detection Result:</span>
              <span class="text-sm ${vt.malicious > 0 ? 'text-red-400' : 'text-green-400'}">
                ${vt.malicious > 0 ? 'Threats Detected' : 'Clean'}
              </span>
            </div>
            <div class="text-xs text-slate-500 mt-1">
              ${vt.malicious} / ${vt.total} scanners flagged this file
            </div>
          </div>
        `;
      }
      
      if (hasGoogleVision) {
        const labels = result.externalVerification.googleVision.labels;
        html += `
          <div class="bg-slate-800/50 rounded-lg p-4">
            <h4 class="font-medium mb-2">Detected Labels</h4>
            <div class="flex flex-wrap gap-2">
              ${labels.map(label => `
                <span class="px-2 py-1 bg-blue-500/20 text-blue-300 rounded text-xs">${label}</span>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      content.innerHTML = html;
    }

    function displayVideoAnalysis(result) {
      const section = document.getElementById('videoAnalysisSection');
      const content = document.getElementById('videoAnalysisContent');
      
      section.classList.remove('hidden');
      
      const va = result.videoAnalysis;
      
      content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">Frames Analyzed</div>
            <div class="text-2xl font-semibold">${va.totalFrames || 0}</div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">AI Frames Detected</div>
            <div class="text-2xl font-semibold ${va.aiFrames > 0 ? 'text-red-400' : 'text-green-400'}">
              ${va.aiFrames || 0}
            </div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">Average Confidence</div>
            <div class="text-2xl font-semibold">${Math.round(va.avgConfidence || 0)}%</div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">AI Content Percentage</div>
            <div class="text-2xl font-semibold ${va.aiPercentage > 30 ? 'text-red-400' : 'text-green-400'}">
              ${Math.round(va.aiPercentage || 0)}%
            </div>
          </div>
        </div>
      `;
    }

    function displayAudioAnalysis(result) {
      const section = document.getElementById('audioAnalysisSection');
      const content = document.getElementById('audioAnalysisContent');
      
      section.classList.remove('hidden');
      
      const aa = result.audioAnalysis;
      
      content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">Synthetic Voice Detection</div>
            <div class="text-xl font-semibold ${aa.syntheticVoice ? 'text-red-400' : 'text-green-400'}">
              ${aa.syntheticVoice ? 'Detected' : 'Not Detected'}
            </div>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-4">
            <div class="text-sm text-slate-400 mb-1">AI Confidence</div>
            <div class="text-2xl font-semibold">${Math.round(aa.aiConfidence || 0)}%</div>
          </div>
        </div>
      `;
    }

    function displayVerificationHistory(result) {
      const firstVerified = result.timestamps?.created || result.created_at;
      const lastUpdated = result.timestamps?.updated || result.updated_at;
      const count = result.verificationCount || result.verification_count;
      
      if (firstVerified) {
        document.getElementById('firstVerified').textContent = new Date(firstVerified).toLocaleString();
      }
      
      if (lastUpdated) {
        document.getElementById('lastUpdated').textContent = new Date(lastUpdated).toLocaleString();
      }
      
      if (count) {
        document.getElementById('verificationCountSection').classList.remove('hidden');
        document.getElementById('verificationCount').textContent = count;
      }
    }

    // Load report on page load
    window.addEventListener('DOMContentLoaded', loadReport);
  </script>

</body>
</html>
