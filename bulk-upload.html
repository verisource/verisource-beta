<!DOCTYPE html>
<html lang="en">
<head>
  <!-- NO auth-check.js -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Upload - VeriSource‚Ñ¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .progress-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  
  <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center text-slate-950 font-bold text-xl">V</div>
          <div>
            <div class="text-lg font-semibold tracking-tight">VeriSource<span class="align-top text-xs ml-0.5">‚Ñ¢</span></div>
            <p class="text-xs text-slate-400">Bulk Upload</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <a href="index.html" class="text-sm text-slate-400 hover:text-blue-400 transition">‚Üê Back to Home</a>
          <a href="single-upload.html" class="text-sm px-4 py-2 rounded-lg border border-slate-700 hover:border-blue-500 hover:bg-slate-900 transition">Single Upload</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    
    <div class="text-center mb-10 fade-in">
      <h1 class="text-3xl md:text-4xl font-bold mb-3">Bulk File Verification</h1>
      <p class="text-slate-400 max-w-2xl mx-auto">Upload multiple files for batch processing. Each file is verified individually and results are compiled into a comprehensive report.</p>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      
      <!-- Upload Section -->
      <div class="lg:col-span-1">
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 space-y-6 fade-in sticky top-24">
          <div>
            <h2 class="text-xl font-semibold mb-2">Select Files</h2>
            <p class="text-sm text-slate-400">Choose multiple images or videos to verify in batch.</p>
          </div>

          <div class="border-2 border-dashed border-slate-700 rounded-xl p-8 text-center hover:border-blue-500/50 transition cursor-pointer bg-slate-900/30" id="dropzone">
            <div class="space-y-4">
              <div class="mx-auto h-16 w-16 rounded-full bg-blue-500/10 flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-slate-200">Drop files here or click to browse</p>
                <p class="text-xs text-slate-500 mt-1">Max 50 files ‚Ä¢ 200MB per file</p>
              </div>
              <input type="file" id="fileInput" accept="image/*,video/*" multiple class="hidden">
            </div>
          </div>

          <div id="filesList" class="hidden">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold">Selected: <span id="fileCount">0</span> files</h3>
              <button onclick="clearAllFiles()" class="text-xs text-red-400 hover:text-red-300">Clear All</button>
            </div>
            <div id="filesContainer" class="space-y-2 max-h-64 overflow-y-auto bg-slate-800/30 rounded-lg p-3"></div>
          </div>

          <button onclick="uploadAllFiles()" id="uploadBtn" disabled class="w-full py-3 px-6 rounded-lg bg-blue-500 text-white font-medium hover:bg-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Verify All Files
          </button>

          <div id="progress" class="hidden space-y-2">
            <div class="flex justify-between text-xs">
              <span id="progressText">Processing...</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
              <div id="progressBar" class="h-full bg-blue-500 progress-bar" style="width: 0%"></div>
            </div>
            <p class="text-xs text-slate-500 text-center" id="progressDetails"></p>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="lg:col-span-2">
        <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Verification Results</h2>
            <button onclick="downloadCSV()" id="downloadBtn" class="hidden text-sm px-4 py-2 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 hover:bg-green-500/30 transition">
              üì• Download CSV
            </button>
          </div>
          
          <div id="resultsPlaceholder" class="text-center py-20">
            <div class="mx-auto h-16 w-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4">
              <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <p class="text-sm text-slate-500">Upload files to see batch verification results</p>
          </div>

          <div id="summaryStats" class="hidden grid grid-cols-3 gap-4 mb-6"></div>
          <div id="results" class="hidden space-y-3"></div>
        </div>
      </div>
    </div>

  </main>

  <script>
    const API_URL = 'https://api.verisource.io';
    let selectedFiles = [];
    let verificationResults = [];
    let isProcessing = false;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');

    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-blue-500');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-blue-500');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-blue-500');
      if (e.dataTransfer.files.length) {
        handleFileSelect(e.dataTransfer.files);
      }
    });

    function handleFileSelect(files) {
      if (!files || files.length === 0) return;
      
      selectedFiles = [];
      for (let i = 0; i < Math.min(files.length, 50); i++) {
        selectedFiles.push(files[i]);
      }
      
      updateFilesList();
      document.getElementById('uploadBtn').disabled = false;
    }

    function updateFilesList() {
      const filesList = document.getElementById('filesList');
      const filesContainer = document.getElementById('filesContainer');
      const fileCount = document.getElementById('fileCount');
      
      if (selectedFiles.length === 0) {
        filesList.classList.add('hidden');
        return;
      }
      
      filesList.classList.remove('hidden');
      fileCount.textContent = selectedFiles.length;
      
      filesContainer.innerHTML = selectedFiles.map((file, idx) => `
        <div class="flex items-center justify-between text-xs bg-slate-900/50 rounded p-2">
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="text-slate-500">${idx + 1}.</span>
            <span class="text-slate-300 truncate">${file.name}</span>
          </div>
          <span class="text-slate-500 text-xs">${formatFileSize(file.size)}</span>
        </div>
      `).join('');
    }

    function clearAllFiles() {
      selectedFiles = [];
      verificationResults = [];
      fileInput.value = '';
      updateFilesList();
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('results').classList.add('hidden');
      document.getElementById('resultsPlaceholder').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.add('hidden');
      document.getElementById('progress').classList.add('hidden');
    }

    async function uploadAllFiles() {
      if (selectedFiles.length === 0 || isProcessing) return;
      
      isProcessing = true;
      verificationResults = [];
      
      const uploadBtn = document.getElementById('uploadBtn');
      const progress = document.getElementById('progress');
      const results = document.getElementById('results');
      const placeholder = document.getElementById('resultsPlaceholder');
      const summaryStats = document.getElementById('summaryStats');
      
      uploadBtn.disabled = true;
      progress.classList.remove('hidden');
      results.classList.add('hidden');
      placeholder.classList.add('hidden');
      summaryStats.classList.add('hidden');
      results.innerHTML = '';
      
      // Process files one by one
      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const percentComplete = Math.round(((i + 1) / selectedFiles.length) * 100);
        
        updateProgress(i + 1, selectedFiles.length, percentComplete, `Verifying ${file.name}...`);
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          
          const res = await fetch(`${API_URL}/verify`, {
            method: 'POST',
            body: formData
          });
          
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          
          const data = await res.json();
          verificationResults.push({
            filename: file.name,
            status: 'success',
            data: data
          });
          
        } catch (error) {
          console.error(`Error verifying ${file.name}:`, error);
          verificationResults.push({
            filename: file.name,
            status: 'error',
            error: error.message
          });
        }
      }
      
      // All done
      progress.classList.add('hidden');
      displayResults();
      document.getElementById('downloadBtn').classList.remove('hidden');
      uploadBtn.disabled = false;
      isProcessing = false;
    }

    function updateProgress(current, total, percent, message) {
      document.getElementById('progressText').textContent = message;
      document.getElementById('progressPercent').textContent = `${percent}%`;
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('progressDetails').textContent = `${current} of ${total} files processed`;
    }

    function displayResults() {
      const results = document.getElementById('results');
      const summaryStats = document.getElementById('summaryStats');
      
      const successCount = verificationResults.filter(r => r.status === 'success').length;
      const errorCount = verificationResults.filter(r => r.status === 'error').length;
      const authenticCount = verificationResults.filter(r => 
        r.status === 'success' && (r.data.confidence?.percentage >= 75)
      ).length;
      
      // Summary stats
      summaryStats.classList.remove('hidden');
      summaryStats.innerHTML = `
        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-green-400">${successCount}</p>
          <p class="text-xs text-slate-400 mt-1">Verified</p>
        </div>
        <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-emerald-400">${authenticCount}</p>
          <p class="text-xs text-slate-400 mt-1">Authentic</p>
        </div>
        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
          <p class="text-2xl font-bold text-red-400">${errorCount}</p>
          <p class="text-xs text-slate-400 mt-1">Failed</p>
        </div>
      `;
      
      // Individual results
      results.classList.remove('hidden');
      results.innerHTML = verificationResults.map((result, idx) => {
        if (result.status === 'error') {
          return `
            <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="text-red-400 text-xl">‚ùå</span>
                  <div>
                    <p class="text-sm font-medium text-slate-200">${result.filename}</p>
                    <p class="text-xs text-red-400 mt-1">Error: ${result.error}</p>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        const conf = result.data.confidence || {};
        const statusColor = conf.color || '#F59E0B';
        const statusLabel = conf.label || 'VERIFIED';
        
        return `
          <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4 hover:bg-slate-800/50 transition">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3 flex-1 min-w-0">
                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: ${statusColor}20;">
                  <span style="color: ${statusColor}">‚úì</span>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-slate-200 truncate">${result.filename}</p>
                  <p class="text-xs mt-1" style="color: ${statusColor}">${statusLabel} ‚Ä¢ ${conf.percentage || 50}% confidence</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-slate-500">${result.data.kind?.toUpperCase() || 'IMAGE'}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function downloadCSV() {
      const csvRows = [];
      csvRows.push(['Filename', 'Status', 'Verdict', 'Confidence %', 'File Type', 'SHA-256', 'Error'].join(','));
      
      verificationResults.forEach(result => {
        if (result.status === 'error') {
          csvRows.push([
            `"${result.filename}"`,
            'Error',
            '-',
            '-',
            '-',
            '-',
            `"${result.error}"`
          ].join(','));
        } else {
          const conf = result.data.confidence || {};
          csvRows.push([
            `"${result.filename}"`,
            'Success',
            conf.label || 'VERIFIED',
            conf.percentage || 50,
            result.data.kind || 'image',
            result.data.fingerprint?.hash || 'N/A',
            ''
          ].join(','));
        }
      });
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `verisource-batch-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
  </script>
</body>
</html>
